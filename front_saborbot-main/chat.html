
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat - ChefBot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <style>
    .message-user { 
      background-color: #e3f2fd; 
      padding: 10px; 
      border-radius: 8px; 
      margin-bottom: 8px; 
    }
    .message-bot { 
      background-color: #f1f8e9; 
      padding: 10px; 
      border-radius: 8px; 
      margin-bottom: 8px; 
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container-fluid vh-100 d-flex">
    <!-- Historial -->
    <div class="col-3 bg-light border-end p-3">
      <h5>Historial</h5>
      <ul class="list-group" id="historial"></ul>

      <h6 class="mt-3">Imagen generada</h6>
      <div id="imagenContainer" class="text-center mt-2"></div>
    </div>

    <!-- Chat -->
    <div class="col-9 d-flex flex-column p-3">
      <div class="flex-grow-1 border rounded p-3 mb-3 bg-white overflow-auto" id="chatOutput"></div>
      <form id="chatForm" class="d-flex">
        <input id="message" type="text" class="form-control me-2" placeholder="Escribe tu consulta...">
        <button id="sendBtn" class="btn btn-primary">Enviar</button>
      </form>
    </div>
  </div>

  <script>
    let lastRecetaId = null;

    async function cargarHistorial() {
      const recetas = await apiFetch("/recetasbyuser");
      const historial = document.getElementById("historial");
      historial.innerHTML = "";
      recetas.forEach(r => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.innerHTML = `<a href="detalle.html?id=${r.id}">${r.titulo}</a>`;
        historial.appendChild(li);
      });
    }

    document.getElementById("chatForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = document.getElementById("message").value;
      if (!msg.trim()) return;

      const chatOutput = document.getElementById("chatOutput");
      const sendBtn = document.getElementById("sendBtn");

      // Mostrar mensaje del usuario
      chatOutput.innerHTML += `<div class="message-user"><b>Tú:</b> ${msg}</div>`;
      document.getElementById("message").value = "";

      // Loader
      const loader = document.createElement("div");
      loader.className = "loader";
      chatOutput.appendChild(loader);

      // Desactivar botón
      sendBtn.disabled = true;

      try {
        const res = await apiFetch("/chat", {
          method: "POST",
          body: JSON.stringify({ message: msg })
        });

        // Eliminar loader
        loader.remove();

        // Mostrar respuesta bot
        chatOutput.innerHTML += `<div class="message-bot"><b>ChefBot:</b><br>${res.response.replace(/\n/g, "<br>")}</div>`;

        // Guardar receta id
        lastRecetaId = res.id_receta;

        // Botón para generar imagen
        chatOutput.innerHTML += `
          <button class="btn btn-success btn-sm mb-3" onclick="generarImagen(${lastRecetaId})">
            Generar Imagen de esta receta
          </button>
        `;

        chatOutput.scrollTop = chatOutput.scrollHeight;

        cargarHistorial();
      } catch (err) {
        console.error(err);
        loader.remove();
        alert("Error al obtener respuesta del chat");
      } finally {
        sendBtn.disabled = false;
      }
    });

    async function generarImagen(recetaId) {
      const imagenContainer = document.getElementById("imagenContainer");
      imagenContainer.innerHTML = `<div class="loader"></div>`;
      try {
        const res = await apiFetch(`/generate-image/${recetaId}`, {
          method: "POST",
          body: JSON.stringify({ width: 512, height: 512, quality: "high" })
        });
        if (res.image_base64) {
          imagenContainer.innerHTML = `<img src="data:image/png;base64,${res.image_base64}" class="img-fluid rounded shadow">`;
        } else {
          imagenContainer.innerHTML = "<p class='text-danger'>No se pudo generar la imagen</p>";
        }
      } catch (err) {
        console.error(err);
        imagenContainer.innerHTML = "<p class='text-danger'>Error al generar la imagen</p>";
      }
    }

    cargarHistorial();
  </script>
</body>
</html>

